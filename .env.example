# Proxy API Keys (REQUIRED for security)
# All endpoints except /health require X-API-Key header matching one of these keys
# (including /metrics which now requires authentication)
# If not set, the proxy operates in fail-closed mode: all authenticated endpoints return
# 500 errors (preventing accidental exposure), while /health remains publicly accessible
# Use strong, randomly generated keys (e.g., from `openssl rand -base64 32`)
# Multiple keys can be comma-separated for key rotation
PROXY_API_KEYS=your-secret-key-1,your-secret-key-2

# OpenRouter API Key (required)
# Get your key at: https://openrouter.ai/keys
OPENROUTER_API_KEY=sk-or-v1-your-api-key-here

# OpenRouter Base URL (optional)
# OPENROUTER_BASE_URL=https://openrouter.ai/api/v1

# Model Mapping (optional)
# Default: GPT-5.2 for Sonnet/Opus, Claude Haiku for small
# TARGET_MODEL_DEFAULT=openai/gpt-5.2
# TARGET_MODEL_SMALL=anthropic/claude-haiku-4.5
# TARGET_MODEL_BIG=openai/gpt-5.2
# TARGET_MODEL_OPUS=openai/gpt-5.2-pro

# Or use Claude models through OpenRouter:
# TARGET_MODEL_DEFAULT=anthropic/claude-sonnet-4.5
# TARGET_MODEL_SMALL=anthropic/claude-haiku-4.5
# TARGET_MODEL_BIG=anthropic/claude-sonnet-4.5
# TARGET_MODEL_OPUS=anthropic/claude-opus-4.5

# OpenRouter App Info (optional)
# These are used for OpenRouter analytics and rate limiting
# OPENROUTER_APP_URL=https://your-app.com
# OPENROUTER_APP_TITLE=Your App Name

# Server Configuration (optional)
# PORT=8000
# HOST=0.0.0.0

# Request Timeout in seconds (optional)
# TIMEOUT_S=300

# Proxy-side WebSearch via Exa (optional)
# If enabled (default true) and EXA_API_KEY is set, the proxy will intercept
# Claude Code's WebSearch tool calls, execute Exa search server-side, and return
# Claude-compatible web_search_tool_result blocks to the model.
# PROXY_WEBSEARCH_ENABLED=true
EXA_API_KEY=your-exa-api-key-here
# EXA_BASE_URL=https://api.exa.ai
# EXA_MAX_RESULTS=5
# EXA_USE_AUTOPROMPT=true
# EXA_SEARCH_TYPE=auto
# EXA_TEXT_MAX_CHARS=2000
# PROXY_TOOLS_MAX_ITERS=3

# Fallback Configuration (Feature C: Routing+Fallback)
# When a request fails with specific status codes or errors, the proxy will
# automatically retry with fallback models. Fallback models are tried in order
# until one succeeds or all models are exhausted.
#
# Fallback models for Sonnet requests (comma-separated list)
# Example: FALLBACK_MODELS_SONNET=anthropic/claude-sonnet-4.5,openai/gpt-5.2
# FALLBACK_MODELS_SONNET=
#
# Fallback models for Opus requests (comma-separated list)
# Example: FALLBACK_MODELS_OPUS=anthropic/claude-opus-4.5,openai/gpt-5.2-pro
# FALLBACK_MODELS_OPUS=
#
# Fallback models for Haiku requests (comma-separated list)
# Example: FALLBACK_MODELS_HAIKU=anthropic/claude-haiku-4.5,openai/gpt-5.2-mini
# FALLBACK_MODELS_HAIKU=
#
# HTTP status codes that trigger fallback (comma-separated)
# Default: 429 (rate limit), 500 (server error), 502 (bad gateway),
#          503 (service unavailable), 504 (gateway timeout)
# Non-integer values are ignored with a warning. Valid range: 100-599.
# FALLBACK_ON_STATUS=429,500,502,503,504
#
# Maximum number of models to try (including primary model)
# Default: 3 (primary + 2 fallbacks). Valid range: 1-10.
# Values outside this range are clamped with a warning.
# FALLBACK_MAX_TRIES=3
#
# Behavior:
# - Fallback triggers on:
#   1. HTTP status codes in FALLBACK_ON_STATUS
#   2. Network timeouts (TIMEOUT_S exceeded)
#   3. Request errors (connection failures, DNS errors, etc.)
# - Non-streaming: Retries with next fallback model on any of the above errors
# - Streaming: Fallback only before first SSE event is sent to client
# - Request ID is logged for all fallback attempts for debugging

# Debug and Monitoring (optional)
# Enable debug dumps of OpenRouter requests to /tmp/last_openrouter_request.json
# When enabled, message content will be redacted (replaced with length info)
# and Authorization headers will be stripped before writing
# DEBUG_DUMP_REQUESTS=false

# Prometheus Metrics
# Metrics are exposed at /metrics endpoint (requires X-API-Key authentication)
# Tracks request count, latency histogram, and error count for /v1/messages
# No configuration needed - just access http://your-server:8000/metrics with X-API-Key header

# Token Quota Configuration (Feature D: tokens/day quotas)
# Enforce daily token limits per API key (counts both input and output tokens).
# Configure quotas via JSON object string OR JSON file (file takes precedence if both set).
#
# QUOTA_CONFIG_JSON: JSON object mapping API keys to daily token limits
# Example: QUOTA_CONFIG_JSON='{"your-key-1": 1000000, "your-key-2": 500000}'
# QUOTA_CONFIG_JSON=
#
# QUOTA_CONFIG_FILE: Path to JSON file containing quota configuration
# File format: {"api-key-1": 1000000, "api-key-2": 500000}
# Example: QUOTA_CONFIG_FILE=/etc/claudeproxy/quotas.json
# QUOTA_CONFIG_FILE=
#
# QUOTA_STATE_FILE: Path to quota state persistence file (default: ./quota_state.json)
# Stores per-key usage and reset_at timestamp (UTC midnight)
# QUOTA_STATE_FILE=./quota_state.json
#
# Behavior:
# - On request start (after auth, after JSON body parsed):
#   1. Estimate tokens: count_anthropic_request_tokens(body) + max_tokens
#   2. Check if quota exceeded → return 429 with X-Request-Id header
#   3. If allowed → reserve tokens immediately
# - After completion:
#   - Non-streaming: use anthropic_response['usage'] to reconcile actual usage
#   - Streaming: collect final input_tokens/output_tokens and reconcile at end of stream
# - Quota resets at UTC midnight daily
# - State persisted to QUOTA_STATE_FILE with thread-safe locking (asyncio.Lock)
#
# Admin view: GET /v1/usage (requires X-API-Key)
# Returns masked keys with usage, quota, remaining tokens, and reset time

# Admin API Configuration (Feature E: Admin/DX endpoints)
# ADMIN_API_KEY: Secret key for admin endpoints (X-Admin-Key header)
# Use a strong, randomly generated key (e.g., from `openssl rand -base64 32`)
# Admin endpoints require BOTH X-API-Key (normal auth) AND X-Admin-Key (admin auth)
# ADMIN_API_KEY=your-admin-secret-key
#
# Enhanced /health endpoint (public, no auth required):
# - Returns: status, uptime_seconds, version, enabled_features, config_summary
# - enabled_features: {auth, metrics, fallback, quotas, debug_dump}
# - config_summary: basic config without secrets (api_keys_count, model_mapping, etc.)
#
# GET /v1/admin/stats (requires X-API-Key + X-Admin-Key):
# - Returns: uptime_seconds, metrics_snapshot, quota_enabled_keys_count
# - metrics_snapshot: proxy_requests_total counts for /v1/messages by status code
#
# GET /v1/admin/config (requires X-API-Key + X-Admin-Key):
# - Returns sanitized config: model_mapping, fallback_settings, quota_settings, debug_flags
# - No secrets included (no API keys, no quota values)
# - Includes: model names, fallback models, status codes, filenames, flags
